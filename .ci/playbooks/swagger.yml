---
- name: "build swagger and push it to a private repo"
  community.docker.docker_image:
    build:
      path: "{{ ansible_env.HOME }}/{{ repository }}/swagger"
    name: "vnmntn/swagger"
    tag: "{{ tag }}"
    push: yes
    source: build

- name: create swagger service
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Service
      metadata:
        name: "swagger"
        namespace: "{{namespace}}"
      spec:
        selector:
          app: "swagger"
        ports:
          - name: web
            port: 80
            targetPort: 5000

- name: create swagger deployment
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: "swagger"
        namespace: "{{ namespace }}"
        labels:
          app: "swagger"
      spec:
        replicas: 1
        selector:
          matchLabels:
            app: "swagger"
        template:
          metadata:
            labels:
              app: "swagger"
          spec:
            containers:
              - name: swagger
                image: "vnmntn/swagger:{{ tag }}"
                imagePullPolicy: IfNotPresent
                args:
                  - "serve"
                  - "/app/swagger.yml"
                  - "-p"
                  - "5000"
                  - "--no-open"
                  - "--path"
                  - "/"

- name: create swagger ingress
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: networking.k8s.io/v1
      kind: Ingress
      metadata:
        name: "swagger"
        namespace: "{{ namespace }}"
      spec:
        ingressClassName: nginx
        rules:
          - host: "swagger.vnmntn.com"
            http:
              paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: swagger
                      port:
                        number: 80

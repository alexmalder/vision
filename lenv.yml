variables:
  TAG: 0.1.5
  NAMESPACE: cv

stages:
  - stage: build
    script:
      - docker build . -t $DOCKER_REGISTRY/library/vision:$TAG
      - docker push $DOCKER_REGISTRY/library/vision:$TAG
    only:
      - main
  - stage: prepare
    script:
      - docker-compose up --build -d
    only:
      - main
  - stage: deploy
    script:
      - helm repo add template https://$DOCKER_REGISTRY/chartrepo/library
      - helm upgrade --install 
        vision template/template
        --namespace $NAMESPACE 
        --create-namespace 
        --set image.tag=$TAG 
        --set env.TNT_USER=$TNT_USER 
        --set env.TNT_PASSWORD=$TNT_PASSWORD 
        --set env.TNT_HOST=$TNT_HOST 
        --set env.TNT_PORT=$TNT_PORT
        -f .ci/values.yaml
    only:
      - main
